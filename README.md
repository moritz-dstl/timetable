# Fottg - Free Online Timetable Generator
![FOTTG Logo](images/FOTTG.png)

# Getting Started

## Prerequisites

- npm (v10 or higher recommended)

## Installation

<details>
<summary>API</summary>

Before you can run the API and database, you need to create a file named `config.py` inside the `backend` directory.This file should include the database credentials as well as a secret key used to encrypt cookies generated by the website. The File should look like this:
```
DB_USER = "root"
DB_PASSWORD = "DB_PASSWORD" # in a real-world scenario, this should be stored securely
DB_HOST = "mariadb-container"
DB_NAME = "timetable-database"

SQLALCHEMY_DATABASE_URI = f"mysql+pymysql://{DB_USER}:{DB_PASSWORD}@{DB_HOST}/{DB_NAME}"
SQLALCHEMY_TRACK_MODIFICATIONS = False


SECRET_KEY = "extremly_secret_key"
```

To run the API and Database, navigate to the folder of the cloned Git repository in your terminal and execute:
```
docker compose up -d --build
```
This command will build all images and start all containers, including the database and the API container.

Once everything is running, you can use the following API endpoints via `localhost:8000`

</details>

<hr/>

<details>
<summary>Frontend</summary>

1. Clone the repository:
   ```bash
   git clone https://github.com/moritz-dstl/timetable
   cd timetable
   ```
   
2. Change to frontend directory:
   ```bash
   cd src/frontend
   ```

3. Install dependencies:
   ```bash
   npm i
   ```

4. Start the development server:
   ```bash
   npm run dev
   ```

</details>

<br/>

# Usage Guide

<details>
<summary>API</summary>

## API Documentation
**IMPORTANT: Always include credentials when sending an API request**

## Register a new user
Use the endpoint `POST /User/register` with a JSON body like:
```
{ "email": "jane.doe@example.com", "password": "password_string", "school_name": "school_name_as_string" }
```
This creates a new user in the database. If the email already exists, the server will return status code 400.

## Log in
Use the endpoint `POST /User/login` with a JSON body like:
```
{ "email": "jane.doe@example.com", "password": "password_string" }
```
This checks if a user with the given email and password exists. If successful, a session token containing the user ID (Uid) is created and HTTP status 200 is returned. Otherwise, HTTP status 401 is returned.

## Get school name
Use the endpoint `GET /User/get_school` without any body. This will return a json with the User's school name:
```
{"school_name": "school name"}
```

## Log out
Use the endpoint `POST /User/logout` without any body. This clears the current session and returns HTTP status 200.


## Set settings
The endpoint `POST /Settings/set` expects a JSON object containing the following keys:

<details>
<summary>Keys</summary>

**`settings`: general configuration for the timetable generator. Fields must include**:
|             Key           |   Type   |                             Description                              |
|---------------------------|----------|----------------------------------------------------------------------|
| `prefer_early_hours`      | `bool`   | whether earlier periods should be preferred                          |
| `allow_block_scheduling`  | `bool`   | whether double lessons (blocks) are allowed                          |
| `max_hours_per_day`       | `int`    | maximum number of hours a subject can appear per day                 |
| `max_consecutive_hours`   | `int`    | maximum consecutive lessons allowed in a day                         |
| `break_window_start`      | `int`    | inclusive                                                            |
| `break_window_end`        | `int`    | inclusive; define the time window in which a lunchbreak must occur   |
| `weight_block_scheduling` | `int`    | weighting factor for encouraging block scheduling                    |
| `weight_time_of_hours`    | `int`    | weighting factor for the preference of early or late hours           |
| `max_time_for_solving`    | `int`    | maximum solving time in seconds for the timetable algorithm          |
<br/>

**`school`: structure of the school with:**
|             Key           |   Type   |                             Description                              |
|---------------------------|----------|----------------------------------------------------------------------|
| `classes`                 | `list`   | e.g. ["C1", "C2", "C3"]                                              |
| `subjects`                | `list`   | e.g. ["Math", "English", "Physics"]                                  |
| `hours_per_day`           | `int`    | number of periods per day                                            |
<br/>

**`teachers`: list of teachers. Each teacher object includes:**
|             Key           |   Type   |                             Description                              |
|---------------------------|----------|----------------------------------------------------------------------|
| `name`                    | `string` | full name of the teacher                                             |
| `max_hours`               | `int`    | maximum weekly teaching load                                         |
| `subjects`                | `list`   | list of subjects the teacher can teach                               |
<br/>

**`class_allocations`: list of subjects assigned to each class, each with:**
|             Key           |   Type   |                             Description                              |
|---------------------------|----------|----------------------------------------------------------------------|
| `class_name`              | `string` |                                                                      |
| `subject`                 | `string` | name of subject                                                      |
| `hours_per_week`          | `int`    | amount of hours subject has to be teached per week                   |
<br/>

**`subject_parallel_limits`: optional list of subjects that cannot be taught in too many classes at once (e.g. due to room constraints). Each entry includes:**
|             Key           |   Type   |                             Description                              |
|---------------------------|----------|----------------------------------------------------------------------|
| `subject_name`            | `string` |                                                                      |
| `max_parallel`            | `int`    | max simultaneous occurrences                                         |
<br/>

**`prefer_block_subjects`: optional list of subjects that strongly prefer to be scheduled in double periods, each with:**
|             Key           |   Type   |                             Description                              |
|---------------------------|----------|----------------------------------------------------------------------|
| `subject_name`            | `string` |                                                                      |
| `weight`                  | `int`    | Numeric weight (should be set **higher than 10**. A value above 50 will almost always ensure the subject is scheduled as a block)|

</details>

<details>
<summary><strong>Example</strong></summary>

```
    {
    "settings": {
        "prefer_early_hours": true,
        "allow_block_scheduling": true,
        "max_hours_per_day": 2,
        "max_consecutive_hours": 7,
        "break_window_start": 4,
        "break_window_end": 6,
        "weight_block_scheduling": 10,
        "weight_time_of_hours": 10,
        "max_time_for_solving": 180
    },

    "school": {
        "classes": ["C1", "C2", "C3"],
        "subjects": ["Math", "German", "English", "PE",
                    "Biology", "Chemistry", "Physics", "History"],
        "hours_per_day": 8
    },

    "teachers": [
        { "name": "Smith",    "max_hours": 20, "subjects": ["Math", "Physics"] },
        { "name": "Johnson",  "max_hours": 20, "subjects": ["German", "History"] },
        { "name": "Williams", "max_hours": 18, "subjects": ["English", "History"] },
        { "name": "Brown",    "max_hours": 18, "subjects": ["PE", "Biology"] },
        { "name": "Taylor",   "max_hours": 18, "subjects": ["Chemistry", "Biology"] }
    ],

    "class_allocations": [
        { "class_name": "C1", "subject": "Math",     "hours_per_week": 4 },
        { "class_name": "C1", "subject": "German",   "hours_per_week": 3 },
        { "class_name": "C1", "subject": "English",  "hours_per_week": 3 },
        { "class_name": "C1", "subject": "PE",       "hours_per_week": 2 },
        { "class_name": "C1", "subject": "Biology",  "hours_per_week": 2 },
        { "class_name": "C1", "subject": "Chemistry","hours_per_week": 2 },
        { "class_name": "C1", "subject": "Physics",  "hours_per_week": 2 },
        { "class_name": "C1", "subject": "History",  "hours_per_week": 2 },

        { "class_name": "C2", "subject": "Math",     "hours_per_week": 4 },
        { "class_name": "C2", "subject": "German",   "hours_per_week": 3 },
        { "class_name": "C2", "subject": "English",  "hours_per_week": 3 },
        { "class_name": "C2", "subject": "PE",       "hours_per_week": 2 },
        { "class_name": "C2", "subject": "Biology",  "hours_per_week": 2 },
        { "class_name": "C2", "subject": "Chemistry","hours_per_week": 2 },
        { "class_name": "C2", "subject": "Physics",  "hours_per_week": 2 },
        { "class_name": "C2", "subject": "History",  "hours_per_week": 2 },

        { "class_name": "C3", "subject": "Math",     "hours_per_week": 4 },
        { "class_name": "C3", "subject": "German",   "hours_per_week": 3 },
        { "class_name": "C3", "subject": "English",  "hours_per_week": 3 },
        { "class_name": "C3", "subject": "PE",       "hours_per_week": 2 },
        { "class_name": "C3", "subject": "Biology",  "hours_per_week": 2 },
        { "class_name": "C3", "subject": "Chemistry","hours_per_week": 2 },
        { "class_name": "C3", "subject": "Physics",  "hours_per_week": 2 },
        { "class_name": "C3", "subject": "History",  "hours_per_week": 2 }
    ],

    "subject_parallel_limits": [
        { "subject_name": "PE",        "max_parallel": 2 },
        { "subject_name": "Chemistry", "max_parallel": 2 },
        { "subject_name": "Biology",   "max_parallel": 2 }
    ],

    "prefer_block_subjects": [
        { "subject_name": "PE", "weight": 60 }
    ]
    }
```

</details>

## Get settings
The endpoint `GET /Settings/get` returns a JSON object with the following structure:


<details>
<summary><strong>Example</strong></summary>

```
    {
        "classes": [
            {
                "class_name": "C1",
                "hours_per_week": 4,
                "subject": "Math"
            },
            {
                "class_name": "C1",
                "hours_per_week": 3,
                "subject": "English"
            },
            {
                "class_name": "C2",
                "hours_per_week": 4,
                "subject": "Math"
            },
            {
                "class_name": "C2",
                "hours_per_week": 3,
                "subject": "PE"
            },
            {
                "class_name": "C3",
                "hours_per_week": 4,
                "subject": "Math"
            },
            {
                "class_name": "C3",
                "hours_per_week": 3,
                "subject": "German"
            }
        ],
        "prefer_block_subjects": [
            {
                "subject_name": "PE",
                "weight": 60
            }
        ],
        "school": {
            "Uid": 1,
            "classes": "['C1', 'C2', 'C3']",
            "hours_per_day": 8,
            "subjects": "['Math', 'German', 'English', 'PE']"
        },
        "settings": {
            "Uid": 1,
            "allow_block_scheduling": 1,
            "break_window_end": 6,
            "break_window_start": 4,
            "max_consecutive_hours": 7,
            "max_hours_per_day": 2,
            "max_time_for_solving": 180,
            "prefer_early_hours": 1,
            "weight_block_scheduling": 10,
            "weight_time_of_hours": 10
        },
        "subject_parallel_limits": [
            {
                "max_parallel": 2,
                "subject_name": "PE"
            }
        ],
        "teacher_subjects": [
            {
                "Tid": 26,
                "subject": "Math"
            },
            {
                "Tid": 27,
                "subject": "German"
            },
            {
                "Tid": 28,
                "subject": "English"
            },
            {
                "Tid": 29,
                "subject": "PE"
            },
        ],
        "teachers": [
            {
                "Tid": 26,
                "max_hours": 20,
                "name": "Smith"
            },
            {
                "Tid": 27,
                "max_hours": 20,
                "name": "Johnson"
            },
            {
                "Tid": 28,
                "max_hours": 18,
                "name": "Williams"
            },
            {
                "Tid": 29,
                "max_hours": 18,
                "name": "Brown"
            }
        ]
    }
```

</details>

## Compute timetable
The endpoint `GET /start_computing` starts the computing progress and instantly returns:
```
{
    "job_id": "24de5582-1b57-42dc-b5a3-bd2c4366806b",
    "status": "started"
}
````

## Status of computing
The endpoint `GET /status/<job_id>` (replace <job_id> with the ID returned from /start_computing) returns the current status of the timetable computation and, if available, the result.

If the status is `still running`, the result will be null:
```
{
    "result": null,
    "status": "running"
}
````

Once the computation is `finished`, the result will contain the full timetable in the following structure:

<details>
<summary>Timetable</summary>

```
{
  "status": "finished",
  "result": {
    "status": "success",
    "classes": {
      "C1": {
        "Mo": ["Subject (Teacher)", "Subject (Teacher)", "free", "..."],
        "Tu": ["...", "..."],
        ...
      },
      "C2": {
        "Mo": ["...", "..."],
        ...
      },
      "C3": {
        "Mo": ["...", "..."],
        ...
      }
    },
    "teachers": {
      "Smith": {
        "Mo": ["Subject (C1)", "Subject (C2)", "free", "..."],
        ...
      },
      "Johnson": {
        "Tu": ["...", "..."],
        ...
      },
      ...
    }
  }
}
```

</details>

</details>

<hr/>

<details>
<summary>Frontend</summary>

## Developer Login
- Email: admin@email.com
- Password: password

</details>
